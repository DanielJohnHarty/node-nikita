// Generated by CoffeeScript 1.9.1
var instance, properties, registry;

instance = function(options) {
  var obj;
  if (options == null) {
    options = {};
  }
  obj = {};
  obj.options = options;
  return obj;
};

module.exports = function() {
  var build, obj, properties, proto, run, status, todos;
  obj = instance.apply(null, arguments);
  properties = {};
  todos = [];
  status = {
    err: null,
    changed: false,
    throw_if_error: true
  };
  run = function() {
    var changed, err, i, k, len, ref, ref1, ref2, ref3, t, todo, v;
    todo = todos.shift();
    if (!todo) {
      if (status.err && status.throw_if_error) {
        throw status.err;
      }
      return;
    }
    if (status.err && todo[0] !== 'then') {
      return run();
    }
    if (todo[0] === 'then') {
      return todo[1][0].call(obj, status.err, status.changed, function(err, changed) {
        status.err = null;
        status.changed = false;
        status.throw_if_error = true;
        if (err) {
          status.err = err;
        } else if (changed) {
          status.changed = true;
        }
        return run();
      });
    }
    if (todo[0] === 'run') {
      if (todo[1][0].length) {
        try {
          return todo[1][0].call(obj, function(err, changed) {
            if (err) {
              status.err = err;
            } else if (changed) {
              status.changed = true;
            }
            return run();
          });
        } catch (_error) {
          err = _error;
          status.err = err;
        }
        run();
      } else {
        try {
          changed = todo[1][0].call(obj);
        } catch (_error) {
          err = _error;
        }
        if (err) {
          status.err = err;
        } else if (changed) {
          status.changed = true;
        }
        run();
      }
      return;
    }
    if (Array.isArray(todo[1][0])) {
      ref = todo[1][0];
      for (i = 0, len = ref.length; i < len; i++) {
        t = ref[i];
        ref1 = obj.options;
        for (k in ref1) {
          v = ref1[k];
          if (typeof t[k] === 'undefined') {
            t[k] = obj.options[k];
          }
        }
      }
    } else {
      t = todo[1][0];
      ref2 = obj.options;
      for (k in ref2) {
        v = ref2[k];
        if (typeof t[k] === 'undefined') {
          t[k] = obj.options[k];
        }
      }
    }
    todo[1][0].user_args = ((ref3 = todo[1][1]) != null ? ref3.length : void 0) > 2;
    return registry[todo[0]].call(obj, todo[1][0], function(err, changed, to) {
      var e, ref4, result;
      result = false;
      try {
        result = (ref4 = todo[1][1]) != null ? ref4.apply(null, arguments) : void 0;
        if (err) {
          status.throw_if_error = false;
        }
        if (result === true) {
          err = null;
        }
      } catch (_error) {
        e = _error;
        if (!err) {
          err = e;
        }
      }
      if (err) {
        status.err = err;
      } else if (changed) {
        status.changed = true;
      }
      return run();
    });
  };
  build = function(name) {
    var builder;
    if (todos.length === 0) {
      process.nextTick(run);
    }
    builder = function() {
      todos.push([name, arguments]);
      return obj;
    };
    return builder;
  };
  properties.then = {
    get: function() {
      return build('then');
    }
  };
  properties.run = {
    get: function() {
      return build('run');
    }
  };
  Object.keys(registry).forEach(function(name) {
    return properties[name] = {
      get: function() {
        return build(name);
      }
    };
  });
  proto = Object.defineProperties(obj, properties);
  return obj;
};

properties = {};

registry = require('./misc/registry');

Object.keys(registry).forEach(function(name) {
  return properties[name] = {
    get: function() {
      return module.exports()[name];
    }
  };
});

properties.run = {
  get: function() {
    return module.exports().run;
  }
};

Object.defineProperties(module.exports, properties);
