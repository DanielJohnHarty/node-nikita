// Generated by CoffeeScript 1.10.0
var db, each, misc;

module.exports = function(options, callback) {
  var adm_cmd, create_cmd, k, modified, ref, ref1, v;
  if (options.db == null) {
    options.db = {};
  }
  ref = options.db;
  for (k in ref) {
    v = ref[k];
    if (options[k] == null) {
      options[k] = v;
    }
  }
  if (options.host == null) {
    return callback(new Error('Missing hostname'));
  }
  if (options.admin_username == null) {
    return callback(new Error('Missing admin name'));
  }
  if (options.admin_password == null) {
    return callback(new Error('Missing admin password'));
  }
  if (!((options.username != null) || (options.users != null))) {
    return callback(new Error('Missing new user username'));
  }
  if (!((options.password != null) || (options.users != null))) {
    return callback(new Error('Missing new user password'));
  }
  if (options.db) {
    if (!Array.isArray(options.db)) {
      options.db = [options.db];
    }
  }
  if (options.users == null) {
    options.users = [];
  }
  if (!Array.isArray(options.users)) {
    return callback(new Error('users  must be an array'));
  }
  if (options.username != null) {
    options.users.push({
      username: "" + options.username,
      password: "" + options.password
    });
  }
  if (options.engine != null) {
    options.engine = options.engine.toUpperCase();
  }
  if (options.engine == null) {
    options.engine = 'POSTGRES';
  }
  if ((ref1 = options.engine) !== 'MYSQL' && ref1 !== 'POSTGRES') {
    return callback(new Error('Unsupport engine type'));
  }
  options.log({
    message: "Database engine set to " + options.engine,
    level: 'INFO',
    module: 'mecano/database/user/add'
  });
  if (options.port == null) {
    options.port = 5432;
  }
  adm_cmd = '';
  create_cmd = '';
  switch (options.engine) {
    case 'MYSQL':
      adm_cmd += 'mysql';
      adm_cmd += " -h " + options.host;
      adm_cmd += " -u " + options.admin_username;
      adm_cmd += " -p " + options.admin_password;
      break;
    case 'POSTGRES':
      adm_cmd += "PGPASSWORD=" + options.admin_password + " psql";
      adm_cmd += " -h " + options.host;
      adm_cmd += " -U " + options.admin_username;
      break;
    default:
      break;
  }
  modified = false;
  return this.call(function() {
    return each(options.users).parallel(false).call((function(_this) {
      return function(user, i, next) {
        if (options.engine !== 'POSTGRES') {
          return;
        }
        if (user.databases == null) {
          user.databases = [];
        }
        _this.execute({
          cmd: adm_cmd + " -tAc \"CREATE USER " + user.username + " WITH PASSWORD '" + user.password + "';\"",
          unless_exec: adm_cmd + " -tAc \"SELECT 1 FROM pg_roles WHERE rolname='" + user.username + "'\" | grep 1"
        });
        _this.execute({
          cmd: adm_cmd + " -tAc \"ALTER USER " + user.username + " WITH PASSWORD '" + user.password + "';\"",
          if_exec: db.cmd(options, {
            admin_username: null,
            admin_password: null
          }, '\\dt') + " 2>&1 >/dev/null | grep -e '^psql:\\sFATAL.*password\\sauthentication\\sfailed\\sfor\\suser.*'"
        });
        _this.call({
          "if": function() {
            return (this.status(-1)) || (this.status(-1));
          },
          handler: function() {
            return modified = true;
          }
        });
        _this.call({
          "if": function() {
            return this.status(-3);
          },
          handler: function() {
            return options.log({
              message: "User created: " + user.username,
              level: 'INFO',
              module: 'mecano/database/user/add'
            });
          }
        });
        _this.call({
          unless: function() {
            return this.status(-4);
          },
          handler: function() {
            return options.log({
              message: "User already exist (skipped): " + user.username,
              level: 'INFO',
              module: 'mecano/database/user/add'
            });
          }
        });
        _this.call({
          "if": function() {
            return this.status(-3);
          },
          handler: function() {
            return options.log({
              message: "Modified Password for user: " + user.username,
              level: 'INFO',
              module: 'mecano/database/user/add'
            });
          }
        });
        return _this.then(next);
      };
    })(this)).then(function(err) {
      return callback(err, modified);
    });
  });
};

misc = require('../../misc');

db = require('../../misc/db');

each = require('each');
