// Generated by CoffeeScript 1.12.5
var db;

module.exports = {
  shy: true,
  handler: function(options) {
    var cmd, k, ref, ref1, v;
    if (options.db == null) {
      options.db = {};
    }
    ref = options.db;
    for (k in ref) {
      v = ref[k];
      if (options[k] == null) {
        options[k] = v;
      }
    }
    if (!options.host) {
      throw Error('Missing option: "hostname"');
    }
    if (!options.admin_username) {
      throw Error('Missing option: "admin_username"');
    }
    if (!options.admin_password) {
      throw Error('Missing option: "admin_password"');
    }
    if (!options.username) {
      throw Error('Missing option: "username"');
    }
    if (!options.engine) {
      throw Error('Missing option: "engine"');
    }
    if (options.engine === 'postgres') {
      console.log('Depracated Value: options "postgres" is deprecated in favor of "postgresql"');
      options.engine = 'postgresql';
    }
    options.engine = options.engine.toLowerCase();
    if ((ref1 = options.engine) !== 'mariadb' && ref1 !== 'mysql' && ref1 !== 'postgresql') {
      throw Error("Unsupport engine: " + (JSON.stringify(options.engine)));
    }
    if (options.port == null) {
      options.port = 5432;
    }
    cmd = (function() {
      switch (options.engine) {
        case 'mariadb':
        case 'mysql':
          return db.cmd(options, {
            database: 'mysql'
          }, "select User from user where User = '" + options.username + "'") + (" | grep '" + options.username + "'");
        case 'postgresql':
          return db.cmd(options, "SELECT 1 FROM pg_roles WHERE rolname='" + options.username + "'") + " | grep 1";
      }
    })();
    return this.system.execute({
      cmd: cmd,
      code_skipped: 1
    });
  }
};

db = require('../../misc/db');
