// Generated by CoffeeScript 1.10.0
var db, each;

module.exports = function(options) {
  var k, ref, ref1, v;
  if (options.db == null) {
    options.db = {};
  }
  ref = options.db;
  for (k in ref) {
    v = ref[k];
    if (options[k] == null) {
      options[k] = v;
    }
  }
  if (!options.host) {
    throw Error('Missing option: "host"');
  }
  if (!options.admin_username) {
    throw Error('Missing option: "admin_username"');
  }
  if (!options.admin_password) {
    throw Error('Missing option: "admin_password"');
  }
  if (!options.username) {
    throw Error('Missing option: "username"');
  }
  if (!options.password) {
    throw Error('Missing option: "password"');
  }
  if (!options.engine) {
    throw Error('Missing option: "engine"');
  }
  options.engine = options.engine.toLowerCase();
  if ((ref1 = options.engine) !== 'postgres') {
    throw Error("Unsupport engine: " + (JSON.stringify(options.engine)));
  }
  if (options.port == null) {
    options.port = 5432;
  }
  this.execute({
    cmd: db.cmd(options, "CREATE USER " + options.username + " WITH PASSWORD '" + options.password + "';"),
    unless_exec: db.cmd(options, "SELECT 1 FROM pg_roles WHERE rolname='" + options.username + "'") + " | grep 1"
  }, function(err, status) {
    if (err) {
      return;
    }
    if (status) {
      return options.log({
        message: "User created: " + options.username,
        level: 'WARN',
        module: 'mecano/db/user/add'
      });
    } else {
      return options.log({
        message: "User already exists: " + options.username,
        level: 'INFO',
        module: 'mecano/db/user/add'
      });
    }
  });
  return this.execute({
    cmd: db.cmd(options, "ALTER USER " + options.username + " WITH PASSWORD '" + options.password + "';"),
    if_exec: db.cmd(options, {
      admin_username: null,
      admin_password: null
    }, '\\dt') + " 2>&1 >/dev/null | grep -e '^psql:\\sFATAL.*password\\sauthentication\\sfailed\\sfor\\suser.*'"
  }, function(err, status) {
    if (err) {
      return;
    }
    if (status) {
      return options.log({
        message: "Password modified: user " + (JSON.stringify(options.username)),
        level: 'WARN',
        module: 'mecano/db/user/add'
      });
    } else {
      return options.log({
        message: "Password not modified: user " + (JSON.stringify(options.username)),
        level: 'INFO',
        module: 'mecano/db/user/add'
      });
    }
  });
};

db = require('../../misc/db');

each = require('each');
