// Generated by CoffeeScript 1.10.0
var docker,
  slice = [].slice;

module.exports = function(options, callback) {
  var cmd, do_run, flag, i, len, opt, p, ref, ref1, ref2, ref3, ref4;
  if (options.image == null) {
    return callback(Error('Missing image'));
  }
  if (options.rm == null) {
    options.rm = true;
  }
  if (options.name == null) {
    options.name = options.container;
  }
  if (!((options.name != null) || options.rm)) {
    options.log({
      message: "Should specify a container name if rm is false",
      level: 'WARN',
      module: 'mecano/docker/run'
    });
  }
  cmd = 'run';
  ref = {
    name: '--name',
    hostname: '-h',
    cpu_shares: '-c',
    cgroup_parent: '--cgroup-parent',
    cid_file: '--cidfile',
    blkio_weight: '--blkio-weight',
    cpuset_cpus: '--cpuset-cpus',
    entrypoint: '--entrypoint',
    ipc: '--ipc',
    log_driver: '--log-driver',
    memory: '-m',
    mac_address: '--mac-address',
    memory_swap: '--memory-swap',
    net: '--net',
    pid: '--pid',
    cwd: '-w'
  };
  for (opt in ref) {
    flag = ref[opt];
    if (options[opt] != null) {
      cmd += " " + flag + " " + options[opt];
    }
  }
  if (options.detach) {
    cmd += ' -d';
  }
  ref1 = {
    rm: '--rm',
    publish_all: '-P',
    privileged: '--privileged',
    read_only: '--read-only'
  };
  for (opt in ref1) {
    flag = ref1[opt];
    if (options[opt]) {
      cmd += " " + flag;
    }
  }
  ref2 = {
    port: '-p',
    volume: '-v',
    device: '--device',
    label: '-l',
    label_file: '--label-file',
    expose: '--expose',
    env: '-e',
    env_file: '--env-file',
    dns: '--dns',
    dns_search: '--dns-search',
    volumes_from: '--volumes-from',
    cap_add: '--cap-add',
    cap_drop: '--cap-drop',
    ulimit: '--ulimit',
    add_host: '--add-host'
  };
  for (opt in ref2) {
    flag = ref2[opt];
    if (options[opt] != null) {
      if (typeof options[opt] === 'string' || typeof options[opt] === 'number') {
        cmd += " " + flag + " " + options[opt];
      } else if (Array.isArray(options[opt])) {
        ref3 = options[opt];
        for (i = 0, len = ref3.length; i < len; i++) {
          p = ref3[i];
          if ((ref4 = typeof p) === 'string' || ref4 === 'number') {
            cmd += " " + flag + " " + p;
          } else {
            callback(Error("Invalid parameter, '" + opt + "' array should only contains string or number"));
          }
        }
      } else {
        callback(Error("Invalid parameter, '" + opt + "' should be string, number or array"));
      }
    }
  }
  cmd += " " + options.image;
  if (options.cmd) {
    cmd += " " + options.cmd;
  }
  delete options.cmd;
  do_run = (function(_this) {
    return function() {
      options.log({
        message: "Running container " + options.name,
        level: 'INFO',
        module: 'mecano/docker/run'
      });
      return _this.execute({
        cmd: docker.wrap(options, cmd)
      }, function() {
        return docker.callback.apply(docker, [callback].concat(slice.call(arguments)));
      });
    };
  })(this);
  if (options.name != null) {
    options.log({
      message: "Checking if container already runned",
      level: 'INFO',
      module: 'mecano/docker/run'
    });
    return this.execute({
      cmd: docker.wrap(options, "ps -a | grep '" + options.name + "'"),
      code_skipped: 1
    }, function(err, exists) {
      if (err) {
        return callback(err);
      }
      if (exists) {
        options.log({
          message: "Container already runned. Skipping",
          level: 'DEBUG',
          module: 'mecano/docker/run'
        });
        return callback();
      } else {
        return do_run();
      }
    });
  } else {
    return do_run();
  }
};

docker = require('../misc/docker');
