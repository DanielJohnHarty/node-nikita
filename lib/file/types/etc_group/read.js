// Generated by CoffeeScript 2.3.0
// # `nikita.system.etc_group.read(options, [callback])`

// Read and parse the group definition file located in "/etc/group".

// ## Options

// * `cache` (boolean)   
//   Cache the result inside the store.
// * `target` (string)   
//   Path to the group definition file, default to "/etc/group".
// * `gid` (string|integer)   
//   Retrieve the information for a specific group name or guid.

// ## Source Code
var string;

module.exports = {
  shy: true,
  handler: function(options, callback) {
    var groups;
    options.log({
      message: "Entering etc_group.read",
      level: 'DEBUG',
      module: 'nikita/lib/system/etc_group/read'
    });
    if (options.target == null) {
      options.target = '/etc/group';
    }
    // Retrieve groups from cache
    groups = null;
    this.call({
      if: options.cache && !!this.store['nikita:etc_group']
    }, function() {
      options.log({
        message: "Get group definition from cache",
        level: 'INFO',
        module: 'nikita/lib/system/etc_group/read'
      });
      return groups = this.store['nikita:etc_group'];
    });
    // Read system groups and place in cache if requested
    this.fs.readFile({
      unless: options.cache && !!this.store['nikita:etc_group'],
      target: options.target,
      encoding: 'ascii'
    }, function(err, content) {
      var i, len, line, ref;
      if (err) {
        throw err;
      }
      if (content == null) {
        return;
      }
      groups = {};
      ref = string.lines(content);
      for (i = 0, len = ref.length; i < len; i++) {
        line = ref[i];
        line = /(.*)\:(.*)\:(.*)\:(.*)/.exec(line);
        if (!line) {
          continue;
        }
        groups[line[1]] = {
          group: line[1],
          password: line[2],
          gid: parseInt(line[3]),
          user_list: line[4] ? line[4].split(',') : []
        };
      }
      if (options.cache) {
        return this.store['nikita:etc_group'] = groups;
      }
    });
    // Pass the group information
    return this.next(function(err) {
      var group;
      if (err) {
        return callback(err);
      }
      if (!options.gid) {
        return callback(null, true, groups);
      }
      if (groups[options.gid] != null) {
        return callback(null, true, groups[options.gid]);
      }
      if (typeof options.gid === 'string' && /\d+/.test(options.gid)) {
        options.gid = parseInt(options.gid, 10);
      }
      group = Object.values(groups).filter(function(group) {
        return group.gid === options.gid;
      })[0];
      if (!group) {
        return callback(Error(`Invalid Option: no gid matching ${JSON.stringify(options.gid)}`));
      }
      return callback(null, true, group);
    });
  }
};


// ## Dependencies
string = require('../../../misc/string');
