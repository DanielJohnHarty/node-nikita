// Generated by CoffeeScript 2.0.2
// # `nikita.file.cson(options, callback)`

// ## Options

// * `backup`   
//   Create a backup, append a provided string to the filename extension or a
//   timestamp if value is not a string.   
// * `content`   
//   Object to stringify.   
// * `target`   
//   File path where to write content to or a callback.   
// * `merge`   
//   Read the target if it exists and merge its content.   

// ## Callback parameters

// * `err`   
//   Error object if any.   
// * `written`   
//   Number of written actions with modifications.   

// ## Example

// ```js
// require('nikita').file.yaml({
//   content: {
//     'my_key': 'my value'
//   },
//   target: '/tmp/my_file'
// }, function(err, written){
//   console.log(err ? err.message : 'Content was updated: ' + !!written);
// });
// ```

// ## Source Code
var fs, misc, season;

module.exports = function(options) {
  if (options.line_width == null) {
    options.line_width = 160;
  }
  options.log({
    message: "Entering file.yaml",
    level: 'DEBUG',
    module: 'nikita/lib/file/yaml'
  });
  if (options.clean == null) {
    options.clean = true;
  }
  if (!options.content) {
    // Validate parameters
    throw Error('Required Option: content');
  }
  if (!options.target) {
    throw Error('Required Option: target');
  }
  // Start real work
  this.call(function(_, callback) {
    if (!options.merge) {
      return callback();
    }
    options.log({
      message: "Get Target Content",
      level: 'DEBUG',
      module: 'nikita/lib/file/cson'
    });
    return fs.readFile(options.ssh, options.target, 'utf8', function(err, content) {
      if ((err != null ? err.code : void 0) === 'ENOENT') {
        options.log({
          message: "No Target Content To Merged",
          level: 'DEBUG',
          module: 'nikita/lib/file/cson'
        });
        return callback();
      }
      if (err && err.code !== 'ENOENT') {
        return callback(err);
      }
      try {
        content = season.parse(content);
        options.content = misc.merge(content, options.content);
        options.log({
          message: "Target Content Merged",
          level: 'DEBUG',
          module: 'nikita/lib/file/cson'
        });
        return callback();
      } catch (error) {
        err = error;
        return callback(err);
      }
    });
  });
  return this.call(function() {
    options.log({
      message: "Serialize Content",
      level: 'DEBUG',
      module: 'nikita/lib/file/cson'
    });
    return this.file({
      content: season.stringify(options.content),
      target: options.target,
      backup: options.backup
    });
  });
};

// ## Dependencies
fs = require('ssh2-fs');

misc = require('../misc');

season = require('season');

// ## Resources

// [season]: https://www.npmjs.com/package/season
