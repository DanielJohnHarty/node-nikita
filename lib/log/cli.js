// Generated by CoffeeScript 1.12.5
var colors, pad, stream, string;

module.exports = {
  ssh: null,
  handler: function(options) {
    var base, base1, base2, ids, k, ref, v;
    if (options.log_cli == null) {
      options.log_cli = {};
    }
    ref = options.log_cli;
    for (k in ref) {
      v = ref[k];
      options[k] = v;
    }
    if (options.argument != null) {
      if (options.enabled == null) {
        options.enabled = options.argument;
      }
    }
    if (options.enabled == null) {
      options.enabled = true;
    }
    if (options.stream == null) {
      options.stream = process.stdout;
    }
    if (options.end == null) {
      options.end = false;
    }
    if (options.divider == null) {
      options.divider = ' : ';
    }
    if (options.depth == null) {
      options.depth = false;
    }
    if (options.pad == null) {
      options.pad = {};
    }
    if (options.time == null) {
      options.time = true;
    }
    if (typeof options.separator === 'string') {
      options.separator = {
        host: options.separator,
        header: options.separator
      };
    }
    if (options.separator == null) {
      options.separator = {};
    }
    if ((base = options.separator).host == null) {
      base.host = options.pad.host == null ? '   ' : ' ';
    }
    if ((base1 = options.separator).header == null) {
      base1.header = options.pad.header == null ? '   ' : ' ';
    }
    if ((base2 = options.separator).time == null) {
      base2.time = options.pad.time == null ? '  ' : ' ';
    }
    if (options.host == null) {
      options.host = options.ssh ? options.ssh.config.host : 'localhost';
    }
    if (options.colors == null) {
      options.colors = process.stdout.isTTY;
    }
    if (options.colors === true) {
      options.colors = {
        status_true: colors.green,
        status_false: colors.cyan.dim,
        status_error: colors.red
      };
    }
    ids = {};
    return this.call(options, stream, {
      serializer: {
        'diff': null,
        'end': function() {
          return "FINISH\n";
        },
        'error': function(err) {
          return "ERROR";
        },
        'header': function(log) {
          if (!options.enabled) {
            return;
          }
          if (options.depth && options.depth < log.headers.length) {
            return;
          }
          ids[log.index] = log;
          return null;
        },
        "lifecycle": function(log) {
          var ref1;
          if (!ids[log.index]) {
            return;
          }
          if ((ref1 = log.message) === 'conditions_failed' || ref1 === 'disabled_true') {
            ids[log.index].disabled = true;
          }
          return null;
        },
        "handled": function(log) {
          var color, header, header_separator, host, host_separator, line, status, time, time_separator;
          status = log.error ? '✘' : log.status && !log.shy ? '✔' : '-';
          color = false;
          if (options.colors) {
            color = log.error ? options.colors.status_error : log.status ? options.colors.status_true : options.colors.status_false;
          }
          log = ids[log.index];
          if (!log) {
            return null;
          }
          if (log.disabled) {
            return null;
          }
          delete ids[log.index];
          time = options.time ? string.print_time(Date.now() - log.time) : '';
          host = options.host;
          host_separator = options.separator.host;
          header = log.headers.join(options.divider);
          header_separator = options.separator.header;
          time_separator = options.time ? options.separator.time : '';
          if (options.pad.host) {
            host = pad(host, options.pad.host);
          }
          if (options.pad.header) {
            header = pad(header, options.pad.header);
          }
          if (options.pad.time) {
            time = pad(time, options.pad.time);
          }
          line = "" + host + host_separator + header + header_separator + status + time_separator + time + "\n";
          if (color) {
            return color(line);
          } else {
            return line;
          }
        },
        'stdin': null,
        'stderr': null,
        'stdout': null,
        'text': null
      }
    });
  }
};

colors = require('colors/safe');

pad = require('pad');

stream = require('./stream');

string = require('../misc/string');
