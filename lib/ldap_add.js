// Generated by CoffeeScript 1.8.0
var execute, wrap;

module.exports = function() {
  return wrap(arguments, function(options, next) {
    var entry, k, ldif, modified, v, vv, _, _i, _j, _len, _len1, _ref, _ref1;
    modified = false;
    if (!options.entry) {
      return next(Error("Mecano `ldap_add`: required property 'entry'"));
    }
    if (!Array.isArray(options.entry)) {
      options.entry = [options.entry];
    }
    ldif = '';
    _ref = options.entry;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      entry = _ref[_i];
      if (!entry.dn) {
        return next(Error("Mecano `ldap_add`: required property 'dn'"));
      }
      ldif += '\n';
      ldif += "dn: " + entry.dn + "\n";
      _ref1 = /^(.*?)=(.+?),.*$/.exec(entry.dn), _ = _ref1[0], k = _ref1[1], v = _ref1[2];
      ldif += "" + k + ": " + v + "\n";
      for (k in entry) {
        v = entry[k];
        if (k === 'dn') {
          continue;
        }
        if (!Array.isArray(v)) {
          v = [v];
        }
        for (_j = 0, _len1 = v.length; _j < _len1; _j++) {
          vv = v[_j];
          ldif += "" + k + ": " + vv + "\n";
        }
      }
    }
    return execute({
      cmd: "ldapadd -c -H " + options.url + " -D " + options.binddn + " -w " + options.passwd + " <<-EOF\n" + ldif + "\nEOF",
      code_skipped: 68,
      ssh: options.ssh,
      log: options.log,
      stdout: options.stdout,
      stderr: options.stderr
    }, function(err, executed, stdout, stderr) {
      var added, _ref2;
      if (err) {
        return next(err);
      }
      modified = ((_ref2 = stderr.match(/Already exists/g)) != null ? _ref2.length : void 0) !== stdout.match(/adding new entry/g).length;
      added = modified;
      return next(err, modified, added);
    });
  });
};

execute = require('./execute');

wrap = require('./misc/wrap');
