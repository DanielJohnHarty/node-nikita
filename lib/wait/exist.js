// Generated by CoffeeScript 2.0.2
// # `nikita.wait.exist(options, [callback])`

// Wait for a file or directory to exists. Status will be
// set to "false" if the file already existed, considering that no
// change had occured. Otherwise it will be set to "true".   

// ## Options  

// * `target` (string|array)   
//   Path to a file or directory.    
// * `interval`   
//   Time interval between which we should wait before re-executing the check,
//   default to 2s.     

// Example:

// ```coffee
// require 'nikita'
// .wait.exist
//   target: "/path/to/file_or_directory"
// .then (err, status) ->
//   # Command succeed, the file now exists
// ```

// ## Source Code
var each, ssh2fs;

module.exports = function(options, callback) {
  var modified;
  modified = false;
  if (options.target == null) {
    // Validate parameters
    return callback(Error(`Missing target: ${options.target}`));
  }
  if (!Array.isArray(options.target)) {
    options.target = [options.target];
  }
  if (options.interval == null) {
    options.interval = 2000;
  }
  options.log({
    message: "Entering wait for file",
    level: 'DEBUG',
    module: 'nikita/wait/exist'
  });
  modified = false;
  return each(options.target).call((target, next) => {
    var count, run;
    count = 0;
    run = function() {
      count++;
      options.log({
        message: `Attempt #${count}`,
        level: 'INFO',
        module: 'nikita/wait/exist'
      });
      return ssh2fs.stat(options.ssh, target, function(err, stat) {
        if (err && err.code !== 'ENOENT') {
          return next(err);
        }
        if (err) {
          return setTimeout(run, options.interval);
        }
        options.log({
          message: "Finish wait for file",
          level: 'INFO',
          module: 'nikita/wait/exist'
        });
        if (count > 1) {
          modified = true;
        }
        return next();
      });
    };
    return run();
  }).next(function(err) {
    return callback(err, modified);
  });
};

each = require('each');

ssh2fs = require('ssh2-fs');
