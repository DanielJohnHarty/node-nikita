// Generated by CoffeeScript 2.1.1
// # `nikita.krb5.ticket(options, [callback])`

// Renew the Kerberos ticket of a user principal inside a Unix session.

// ## Options

// * `principal`   
//   Principal to be created.   
// * `password`   
//   Password associated to this principal; required if no randkey is
//   provided.   
// * `keytab`   
//   Path to the file storing key entries.   
// * `cache_name` (string)    
//   Path to Kerberos cache file.    
// * `uid`   
//   Unix uid or username of the Unix session   

// ## Keytab example

// ```js
// require('nikita').krb5.ticket({
//   principal: 'myservice/my.fqdn@MY.REALM',
//   keytab: '/etc/security/keytabs/my.service.keytab',
// }, function(err, status){
//   console.log(err ? err.message : 'Is ticket renewed: ' + !!status);
// });
// ```

// ## Source Code
var krb5, uid_gid;

module.exports = function(options) {
  var ssh;
  if (!options.keytab && !options.password) {
    throw Error("Incoherent options: expects one of keytab or password");
  }
  // SSH connection
  ssh = this.ssh(options.ssh);
  this.call(function(_, callback) {
    return uid_gid(ssh, options, callback);
  });
  return this.system.execute({
    cmd: `if ${krb5.su(options, 'klist -s')}; then exit 3; fi\n${krb5.kinit(options)}`,
    code_skipped: 3
  });
};

// ## Dependencies
krb5 = require('../misc/krb5');

uid_gid = require('../misc/uid_gid');
