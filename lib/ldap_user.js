// Generated by CoffeeScript 1.9.1
var each, execute, ldap_add, wrap;

module.exports = function(options, callback) {
  return wrap(this, arguments, function(options, callback) {
    var binddn, modified, passwd, uri;
    binddn = options.binddn ? "-D " + options.binddn : '';
    passwd = options.passwd ? "-w " + options.passwd : '';
    if (options.url) {
      console.log("Mecano: option 'options.url' is deprecated, use 'options.uri'");
      if (options.uri == null) {
        options.uri = options.url;
      }
    }
    if (options.uri === true) {
      options.uri = 'ldapi:///';
    }
    uri = options.uri ? "-H " + options.uri : '';
    if (!options.user) {
      return callback(Error("Mecano `ldap_user`: required property 'user'"));
    }
    if (!Array.isArray(options.user)) {
      options.user = [options.user];
    }
    modified = false;
    return each(options.user).on('item', function(user, callback) {
      var do_checkpass, do_end, do_ldappass, do_user;
      do_user = function() {
        var entry, k, v;
        entry = {};
        for (k in user) {
          v = user[k];
          if (k === 'userPassword') {
            continue;
          }
          entry[k] = v;
        }
        return ldap_add({
          entry: entry,
          uri: options.uri,
          binddn: options.binddn,
          passwd: options.passwd,
          ssh: options.ssh,
          log: options.log,
          stdout: options.stdout,
          stderr: options.stderr
        }, function(err, modified, added) {
          if (err) {
            return callback(err);
          }
          if (modified) {
            if (typeof options.log === "function") {
              options.log('Mecano `ldap_user`: user modified [WARN]');
            }
          }
          if (added) {
            if (typeof options.log === "function") {
              options.log('Mecano `ldap_user`: user added [WARN]');
            }
          }
          if (modified || added) {
            modified = true;
          }
          if (added) {
            return do_ldappass();
          } else {
            return do_checkpass();
          }
        });
      };
      do_checkpass = function() {
        return execute({
          cmd: "ldapsearch -D " + user.dn + " -w " + user.userPassword + " " + uri + " -b \"\" -s base \"objectclass=*\"",
          code_skipped: 49,
          ssh: options.ssh,
          log: options.log,
          stdout: options.stdout,
          stderr: options.stderr
        }, function(err, identical, stdout) {
          if (err) {
            return callback(err);
          }
          if (identical) {
            return do_end();
          } else {
            return do_ldappass();
          }
        });
      };
      do_ldappass = function() {
        return execute({
          cmd: "ldappasswd " + binddn + " " + passwd + " " + uri + " -s " + user.userPassword + " '" + user.dn + "'",
          ssh: options.ssh,
          log: options.log,
          stdout: options.stdout,
          stderr: options.stderr
        }, function(err) {
          if (err) {
            return callback(err);
          }
          if (typeof options.log === "function") {
            options.log('Mecano `ldap_user`: password modified [WARN]');
          }
          modified = true;
          return do_end();
        });
      };
      do_end = function() {
        return callback();
      };
      return do_user();
    }).on('both', function(err) {
      return callback(err, modified);
    });
  });
};

each = require('each');

execute = require('./execute');

ldap_add = require('./ldap_add');

wrap = require('./misc/wrap');
