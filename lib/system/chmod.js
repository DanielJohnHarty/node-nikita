// Generated by CoffeeScript 1.12.5
var fs, misc;

module.exports = function(options) {
  options.log({
    message: "Entering chmod",
    level: 'DEBUG',
    module: 'nikita/lib/system/chmod'
  });
  if (!options.target) {
    throw Error("Missing target: " + (JSON.stringify(options.target)));
  }
  if (!options.mode) {
    throw Error("Missing option 'mode'");
  }
  this.call({
    unless: !!options.stat
  }, function(_, callback) {
    options.log({
      message: "Stat information: \"" + options.target + "\"",
      level: 'DEBUG',
      module: 'nikita/lib/system/chmod'
    });
    return fs.stat(options.ssh, options.target, function(err, stat) {
      if (!err) {
        options.stat = stat;
      }
      return callback(err);
    });
  });
  return this.call(function(_, callback) {
    if (misc.mode.compare(options.stat.mode, options.mode)) {
      options.log({
        message: "Identical permissions on \"" + options.target + "\"",
        level: 'INFO',
        module: 'nikita/lib/system/chmod'
      });
      return callback();
    }
    return fs.chmod(options.ssh, options.target, options.mode, function(err) {
      options.log({
        message: "Change permissions from \"" + (options.stat.mode.toString(8)) + "\" to \"" + (options.mode.toString(8)) + "\" on \"" + options.target + "\"",
        level: 'WARN',
        module: 'nikita/lib/system/chmod'
      });
      return callback(err, true);
    });
  });
};

fs = require('ssh2-fs');

misc = require('../misc');
