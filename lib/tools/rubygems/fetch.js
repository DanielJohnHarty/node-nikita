// Generated by CoffeeScript 1.12.5
var path;

module.exports = function(options, callback) {
  var k, ref, v;
  options.log({
    message: "Entering rubygem.fetch",
    level: 'DEBUG',
    module: 'nikita/lib/tools/rubygem/fetch'
  });
  if (options.ruby == null) {
    options.ruby = {};
  }
  ref = options.ruby;
  for (k in ref) {
    v = ref[k];
    if (options[k] == null) {
      options[k] = v;
    }
  }
  if (options.gem_bin == null) {
    options.gem_bin = 'gem';
  }
  this.system.execute({
    unless: options.version,
    cmd: options.gem_bin + " specification " + options.name + " version -r | grep '^version' | sed 's/.*: \\(.*\\)$/\\1/'",
    cwd: options.cwd,
    shy: true,
    bash: options.bash
  }, function(err, status, stdout) {
    if (err) {
      throw err;
    }
    if (status) {
      options.version = stdout.trim();
    }
    return options.target = options.name + "-" + options.version + ".gem";
  });
  this.call(function() {
    return this.system.execute({
      cmd: options.gem_bin + " fetch " + options.name + " -v " + options.version,
      cwd: options.cwd,
      bash: options.bash
    });
  });
  return this.then(function(err, status) {
    return callback(err, status, options.target, path.resolve(options.cwd, options.target));
  });
};

path = require('path');
